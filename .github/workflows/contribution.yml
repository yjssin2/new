name: Unified Multi-Account Workflow (v7.2 ULTIMATE - RANDOM + INPUT)

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target repository (Owner/Repo)"
        required: true
        default: "yjssin2/new"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.target_repo }}
  cancel-in-progress: false

jobs:
  unified:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        include:
          - account: yjssin2
            email: 18303858+yjssin2@users.noreply.github.com
            token_secret_1: PAT1A
            token_secret_2: PAT1B
            token_secret_3: PAT1C
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Random Activity Counts (Configurable)
        id: randomize
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ² GENERATING RANDOM ACTIVITY FOR ${{ matrix.account }}"
          echo "   (Edit MIN/MAX below to adjust ranges)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # ğŸ”§ SESUAIKAN RANGE DI SINI
          MIN_COMMITS=1650; MAX_COMMITS=2650
          MIN_DAYS=365; MAX_DAYS=365
          MIN_PRS=80; MAX_PRS=120
          MIN_ISSUES=70; MAX_ISSUES=110
          MIN_REPOS=20; MAX_REPOS=25

          COMMITS=$((MIN_COMMITS + RANDOM % (MAX_COMMITS - MIN_COMMITS + 1)))
          DAYS=$((MIN_DAYS + RANDOM % (MAX_DAYS - MIN_DAYS + 1)))
          PRS=$((MIN_PRS + RANDOM % (MAX_PRS - MIN_PRS + 1)))
          ISSUES=$((MIN_ISSUES + RANDOM % (MAX_ISSUES - MIN_ISSUES + 1)))
          REPOS=$((MIN_REPOS + RANDOM % (MAX_REPOS - MIN_REPOS + 1)))

          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "days=$DAYS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT

          echo "âœ… Generated:"
          echo "   Commits: $COMMITS over $DAYS days"
          echo "   PRs: $PRS | Issues: $ISSUES | Repos: $REPOS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Optimized Stagger Delay
        run: |
          SLOT=${{ strategy.job-index }}
          TOTAL_ACCOUNTS=10  # âš  GANTI JIKA TAMBAH AKUN
          if [ $TOTAL_ACCOUNTS -le 10 ]; then
            DELAY=$((SLOT * 2))
          else
            BATCH_SIZE=10
            BATCH=$((SLOT / BATCH_SIZE))
            WITHIN_BATCH=$((SLOT % BATCH_SIZE))
            DELAY=$((BATCH * 90 + WITHIN_BATCH * 15))
          fi
          JITTER=$((RANDOM % 4))
          DELAY=$((DELAY + JITTER))
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ DELAYING START FOR ${{ matrix.account }}"
          echo "   Slot: $SLOT | Delay: ${DELAY}s"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          sleep $DELAY

      - name: Setup Tokens (Secure & Clean)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” LOADING TOKENS FOR ${{ matrix.account }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          mkdir -p /tmp/tokens
          echo "${{ secrets[matrix.token_secret_1] }}" | tr -d '\r\n\t ' > /tmp/tokens/token1
          echo "${{ secrets[matrix.token_secret_2] }}" | tr -d '\r\n\t ' > /tmp/tokens/token2
          echo "${{ secrets[matrix.token_secret_3] }}" | tr -d '\r\n\t ' > /tmp/tokens/token3

          for i in {1..3}; do
            if [ ! -s "/tmp/tokens/token$i" ]; then
              echo "âŒ Token $i is empty!"
              exit 1
            fi
          done
          echo "âœ… All 3 tokens loaded and cleaned"

      - name: Setup Git Identity
        run: |
          git config --global user.name "${{ matrix.account }}"
          git config --global user.email "${{ matrix.email }}"
          echo "âœ… Git identity set for ${{ matrix.account }}"

      - name: "PHASE 1: Create Additional Repositories"
        env:
          REPO_COUNT: ${{ steps.randomize.outputs.repos }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ PHASE 1: CREATE REPOSITORIES"
          echo "   Target: ${{ steps.randomize.outputs.repos }} repos"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          TOKENS=($(cat /tmp/tokens/token1) $(cat /tmp/tokens/token2) $(cat /tmp/tokens/token3))
          WORDS=("quantum" "nova" "lumen" "matrix" "orbit" "vector" "sigma" "neon")
          SUFFIX=("project" "service" "system" "app" "engine" "hub" "core" "cloud")
          SUCCESS=0
          TARGET=${{ steps.randomize.outputs.repos }}

          for ((i=1; i<=TARGET; i++)); do
            T="${TOKENS[$((RANDOM % 3))]}"
            NAME="${WORDS[$RANDOM % ${#WORDS[@]}]}-${SUFFIX[$RANDOM % ${#SUFFIX[@]}]}-${{ matrix.account }}-$(date +%s%N | tail -c 6)"
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $T" -d "{\"name\":\"$NAME\",\"auto_init\":true}" https://api.github.com/user/repos)
            if [ "$CODE" = "201" ]; then
              SUCCESS=$((SUCCESS+1))
              echo "âœ… ($SUCCESS/$TARGET) Created: $NAME"
              sleep 2
            elif [ "$CODE" = "403" ]; then
              echo "âš  Rate limited, waiting 30s..."
              sleep 30
            else
              echo "âš  Unexpected response: $CODE for repo $NAME"
            fi
          done

          echo ""
          echo "âœ… PHASE 1 COMPLETE: $SUCCESS repositories created"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: "PHASE 2: Clone Target Repository"
        env:
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¥ PHASE 2: CLONE TARGET REPOSITORY"
          echo "   Repo: ${{ github.event.inputs.target_repo }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          GH_TOKEN=$(cat /tmp/tokens/token1)
          OWNER="${{ github.event.inputs.target_repo }}"
          OWNER="${OWNER%%/*}"
          REPO="${{ github.event.inputs.target_repo }}"
          REPO="${REPO#*/}"

          BRANCH=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$OWNER/$REPO" | grep -o '"default_branch":"[^"]*' | cut -d'"' -f4)
          if [ -z "$BRANCH" ]; then
            echo "âš  API failed, probing main/master..."
            for b in main master; do
              if git ls-remote --exit-code "https://x-access-token:${GH_TOKEN}@github.com/${{ github.event.inputs.target_repo }}" "$b" >/dev/null 2>&1; then
                BRANCH="$b"
                break
              fi
            done
          fi
          BRANCH="${BRANCH:-main}"
          echo "ğŸ“Œ Detected branch: $BRANCH"

          if git clone --depth=1 --branch="$BRANCH" "https://x-access-token:${GH_TOKEN}@github.com/${{ github.event.inputs.target_repo }}" repo; then
            echo "âœ… Clone successful"
          else
            echo "âŒ Clone failed!"
            exit 1
          fi

          cd repo
          git config user.name "${{ matrix.account }}"
          git config user.email "${{ matrix.email }}"
          echo "DEFAULT_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "âœ… Repository ready for commits"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: "PHASE 3: Create Commits (Direct Push)"
        env:
          TOTAL_COMMITS: ${{ steps.randomize.outputs.commits }}
          TOTAL_DAYS: ${{ steps.randomize.outputs.days }}
          DEFAULT_BRANCH: ${{ env.DEFAULT_BRANCH }}
        run: |
          cd repo
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ PHASE 3: CREATE COMMITS"
          echo "   Target: ${{ steps.randomize.outputs.commits }} commits over ${{ steps.randomize.outputs.days }} days"
          echo "   Branch: ${{ env.DEFAULT_BRANCH }} (DIRECT PUSH)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          GH_TOKEN=$(cat /tmp/tokens/token1)
          mkdir -p .github/activity
          FILE=".github/activity/${{ matrix.account }}.log"
          TOTAL=${{ steps.randomize.outputs.commits }}
          DAYS=${{ steps.randomize.outputs.days }}
          START_DATE=$(date -d "$DAYS days ago" +%Y-%m-%d)

          for ((i=1; i<=TOTAL; i++)); do
            DAY_OFFSET=$((i * DAYS / TOTAL))
            DATE=$(date -d "$START_DATE +$DAY_OFFSET days" +%Y-%m-%d)
            TIME="$DATE 12:00:00 +0000"
            echo "$i|$TIME|${{ matrix.account }}" >> "$FILE"
            git add "$FILE"
            GIT_AUTHOR_DATE="$TIME" GIT_COMMITTER_DATE="$TIME" git commit -m "Activity $i" --no-verify
          done

          echo "ğŸš€ Pushing $TOTAL commits to ${{ env.DEFAULT_BRANCH }}..."
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.event.inputs.target_repo }}"

          PUSH_SUCCESS=false
          for attempt in {1..5}; do
            echo "   Pull-rebase attempt $attempt/5..."
            git pull --rebase origin "${{ env.DEFAULT_BRANCH }}" 2>/dev/null || true
            if git push origin "${{ env.DEFAULT_BRANCH }}"; then
              PUSH_SUCCESS=true
              break
            fi
            sleep $((attempt * 3))
          done

          if [ "$PUSH_SUCCESS" = false ]; then
            echo "âŒ Push failed after 5 attempts!"
            exit 1
          fi

          echo "âœ… PHASE 3 COMPLETE: $TOTAL commits pushed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: "PHASE 4: Create Pull Requests"
        env:
          TOTAL_PRS: ${{ steps.randomize.outputs.prs }}
        run: |
          cd repo
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”€ PHASE 4: CREATE PULL REQUESTS"
          echo "   Target: ${{ steps.randomize.outputs.prs }} PRs"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          TOKENS=($(cat /tmp/tokens/token1) $(cat /tmp/tokens/token2) $(cat /tmp/tokens/token3))
          TOTAL=${{ steps.randomize.outputs.prs }}
          SUCCESS=0

          for ((i=1; i<=TOTAL; i++)); do
            T="${TOKENS[$((RANDOM % 3))]}"
            BRANCH="pr-${{ matrix.account }}-$i-$(date +%s%N | tail -c 6)"
            git checkout -B "$BRANCH" ${{ env.DEFAULT_BRANCH }} >/dev/null 2>&1
            echo "PR content" > "pr_$i.txt"
            git add "pr_$i.txt"
            git commit -m "PR #$i" --no-verify >/dev/null 2>&1
            git push -f "https://x-access-token:${T}@github.com/${{ github.event.inputs.target_repo }}" HEAD:"$BRANCH" >/dev/null 2>&1

            CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${T}" -X POST -d "{\"title\":\"PR #$i by ${{ matrix.account }}\",\"head\":\"$BRANCH\",\"base\":\"${{ env.DEFAULT_BRANCH }}\"}" "https://api.github.com/repos/${{ github.event.inputs.target_repo }}/pulls")
            if [ "$CODE" = "201" ]; then
              SUCCESS=$((SUCCESS+1))
            else
              echo "âš  Failed to create PR $i: $CODE"
            fi

            git push "https://x-access-token:${T}@github.com/${{ github.event.inputs.target_repo }}" --delete "$BRANCH" 2>/dev/null || true

            if [ $((i % 20)) -eq 0 ]; then
              echo "   Progress: $i/$TOTAL PRs created"
            fi
            sleep 0.5
          done

          echo "âœ… PHASE 4 COMPLETE: $SUCCESS PRs created"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: "PHASE 5: Create Issues"
        env:
          TOTAL_ISSUES: ${{ steps.randomize.outputs.issues }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ PHASE 5: CREATE ISSUES"
          echo "   Target: ${{ steps.randomize.outputs.issues }} issues"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          TOKENS=($(cat /tmp/tokens/token1) $(cat /tmp/tokens/token2) $(cat /tmp/tokens/token3))
          TOTAL=${{ steps.randomize.outputs.issues }}
          SUCCESS=0

          for ((i=1; i<=TOTAL; i++)); do
            T="${TOKENS[$((RANDOM % 3))]}"
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${T}" -X POST -d "{\"title\":\"Issue $i - ${{ matrix.account }}\"}" "https://api.github.com/repos/${{ github.event.inputs.target_repo }}/issues")
            if [ "$CODE" = "201" ]; then
              SUCCESS=$((SUCCESS+1))
            else
              echo "âš  Failed to create issue $i: $CODE"
            fi

            if [ $((i % 20)) -eq 0 ]; then
              echo "   Progress: $i/$TOTAL issues created"
            fi
            sleep 0.3
          done

          echo "âœ… PHASE 5 COMPLETE: $SUCCESS issues created"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Final Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ WORKFLOW COMPLETE FOR ${{ matrix.account }}"
          echo "ğŸ“Š ACTIVITY SUMMARY:"
          echo "   Commits: ${{ steps.randomize.outputs.commits }}"
          echo "   PRs: ${{ steps.randomize.outputs.prs }}"
          echo "   Issues: ${{ steps.randomize.outputs.issues }}"
          echo "   Repos: ${{ steps.randomize.outputs.repos }}"
          echo ""
          echo "ğŸ”— Profile: https://github.com/${{ matrix.account }}"
          echo "â° Stats may take 5-15 minutes to appear"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
